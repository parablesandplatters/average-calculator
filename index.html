<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Average calculator — with advanced discreet music player</title>
  <meta name="description" content="Advanced average calculator with robust parsing + discreet old-school music player (1.mp3 .. 10.mp3). Single-file index.html." />
  <style>
    /* ==========================
       Advanced, responsive, black & white UI
       Accessibility-minded, no external assets, single-file
       ========================== */
    :root{
      --bg:#ffffff;
      --fg:#000000;
      --muted:rgba(0,0,0,0.64);
      --accent:var(--fg);
      --mono: "Courier New", Courier, monospace;
      --radius:10px;
      --gap:12px;
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:var(--mono);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

    /* global container */
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:20px;gap:20px;box-sizing:border-box}

    /* card */
    .card{width:100%;max-width:1100px;border:2px solid var(--fg);padding:18px;box-sizing:border-box;background:var(--bg);}

    header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    h1{margin:0;font-size:24px;text-transform:uppercase;letter-spacing:0.08em}
    .sub{font-size:12px;color:var(--muted)}

    main{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:12px}

    @media (max-width:980px){ main{grid-template-columns:1fr} }

    label{display:block;margin-bottom:6px;font-size:13px}
    textarea,input[type="text"]{background:var(--bg);color:var(--fg);border:2px solid var(--fg);padding:12px;font-family:var(--mono);font-size:15px;width:100%;box-sizing:border-box;resize:vertical;min-height:120px}

    .controls{display:flex;gap:10px;flex-wrap:wrap}
    button{background:var(--bg);color:var(--fg);border:2px solid var(--fg);padding:8px 12px;cursor:pointer;font-family:var(--mono);font-size:13px;text-transform:uppercase}
    button[aria-pressed="true"]{outline:3px solid rgba(0,0,0,0.08)}

    .results{margin-top:12px;border-top:1px dashed var(--fg);padding-top:12px;font-size:14px}
    .result-row{display:flex;justify-content:space-between;gap:16px;padding:6px 0}
    .muted{color:var(--muted);font-size:12px}

    /* Player area */
    .player-wrap{border:2px solid var(--fg);padding:12px;border-radius:6px}
    .player-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .player-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .player-controls button{padding:6px 9px;font-size:13px}

    .progress{flex:1;height:8px;background:var(--bg);border:1px solid var(--fg);position:relative;min-width:120px;cursor:pointer}
    .progress .bar{height:100%;background:var(--fg);width:0%}
    .time{font-size:11px;color:var(--muted);min-width:56px;text-align:right}

    .playlist{margin-top:10px;border-top:1px dashed var(--fg);padding-top:8px;max-height:220px;overflow:auto}
    .track{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px dotted rgba(0,0,0,0.04);cursor:pointer}
    .track:hover{background:rgba(0,0,0,0.02)}
    .track[aria-current="true"]{background:rgba(0,0,0,0.06);font-weight:700}

    .small{font-size:11px;padding:6px 8px}
    .volume{display:flex;align-items:center;gap:6px}

    /* compact footer to keep player discreet on small screens */
    footer.music{width:100%;max-width:1100px;padding:6px 8px;font-size:12px;opacity:0.36}

    /* helpful hints */
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    /* accessibility focus styles */
    :focus{outline:3px solid rgba(0,0,0,0.08);outline-offset:2px}

    /* end stylesheet */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <header>
        <div>
          <h1 id="title">Average calculator</h1>
          <div class="sub">Robust parsing • auto-calc • advanced stats • accessible • responsive</div>
        </div>
        <div class="muted">Old-school monochrome UI — single-file (no external libs)</div>
      </header>

      <main>
        <!-- LEFT: calculator -->
        <section aria-labelledby="calc-heading">
          <h2 id="calc-heading" class="muted">Calculator</h2>
          <p class="muted">Enter numeric values separated by commas, spaces, or newlines. Supports scientific notation (e.g. <code>1e3</code>), ignores invalid tokens but reports them.</p>

          <form id="calcForm" onsubmit="return false;" aria-describedby="instructions">
            <label for="numbers">Numbers (comma / newline separated):</label>
            <textarea id="numbers" placeholder="e.g. 10, 20, 30\n1000 2.5 -3" aria-label="Numbers input"></textarea>

            <div style="margin-top:8px" class="controls" aria-hidden="false">
              <button id="calculateBtn" type="button">Calculate</button>
              <button id="clearBtn" type="button">Clear</button>
              <button id="pasteExample" type="button">Insert Example</button>
              <button id="loadDemo" type="button">Load Demo (random)</button>

              <label class="muted" style="align-self:center; margin-left:6px">Auto-calc
                <input id="autocalc" type="checkbox" checked aria-label="Toggle auto calculate" style="margin-left:6px; transform:scale(1.05)" />
              </label>

              <label class="muted" style="align-self:center">Precision
                <input id="precision" type="number" min="0" max="12" value="6" style="width:70px;margin-left:8px" aria-label="Number precision" />
              </label>
            </div>

            <div class="results" id="results" aria-live="polite" aria-atomic="true">
              <div id="error" style="color:var(--fg);"></div>
              <div id="stats" style="display:none;">
                <div class="result-row"><div>Count</div><div id="count">—</div></div>
                <div class="result-row"><div>Sum</div><div id="sum">—</div></div>
                <div class="result-row"><div>Average (mean)</div><div id="avg">—</div></div>
                <div class="result-row"><div>Median</div><div id="median">—</div></div>
                <div class="result-row"><div>Mode</div><div id="mode">—</div></div>
                <div class="result-row"><div>Std. deviation (population)</div><div id="std">—</div></div>
                <div class="result-row"><div>Min</div><div id="min">—</div></div>
                <div class="result-row"><div>Max</div><div id="max">—</div></div>
              </div>
            </div>
          </form>

          <div class="hint">Notes: Non-numeric tokens are ignored but reported. If zero valid numbers are present you'll be prompted to supply valid input. There's also a small debug API available on this page for local use.</div>
        </section>

        <!-- RIGHT: music player -->
        <aside class="player-wrap" aria-labelledby="player-heading">
          <h2 id="player-heading" class="muted">Discreet music player</h2>
          <div class="player-top">
            <div class="player-controls">
              <button id="shuffleBtn" class="small" aria-pressed="false" title="Shuffle">Shuffle</button>
              <button id="prevBtn" class="small" title="Previous">◄◄</button>
              <button id="playBtn" class="small" title="Play / Pause">►</button>
              <button id="nextBtn" class="small" title="Next">►►</button>
              <button id="stopBtn" class="small" title="Stop">■</button>

              <div class="volume" title="volume control">
                <label class="muted">Vol</label>
                <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Volume slider" />
              </div>
            </div>

            <div style="display:flex;align-items:center;gap:8px">
              <div class="time" id="timeDisplay" aria-live="polite">0:00 / 0:00</div>
              <button id="repeatBtn" class="small" aria-pressed="false" title="Repeat mode">Repeat: Off</button>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <div class="progress" id="progressContainer" title="Click to seek">
              <div class="bar" id="progressBar"></div>
            </div>
            <div style="min-width:100px;text-align:right">
              <div id="trackInfo" class="muted">1.mp3</div>
              <div class="muted" style="font-size:11px">Format: mp3 • Mono</div>
            </div>
          </div>

          <div class="playlist" id="playlist" tabindex="0" aria-label="Playlist">
            <!-- Track items inserted by JS for accessibility and dynamic control -->
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button id="downloadBtn" class="small">Download current</button>
            <button id="showAllBtn" class="small">Show playlist (expand)</button>
            <div class="muted" style="margin-left:auto">Playlist: 10 tracks</div>
          </div>
        </aside>
      </main>

      <div class="muted" style="margin-top:12px">Keyboard shortcuts: Space = Play/Pause, ←/→ = Prev/Next, S = Shuffle, R = Repeat, M = Mute/Unmute.</div>

      <footer class="muted" style="margin-top:12px">This single-file app attempts to be robust and friendly — it will still work if some .mp3 files are missing (you'll see an error message and player will skip gracefully).</footer>
    </div>

    <!-- Hidden audio element used programmatically -->
    <audio id="audio" preload="metadata" tabindex="-1" style="display:none"></audio>
  </div>

  <script>
    (function(){
      'use strict';

      /* -------------------- Utilities -------------------- */
      function $id(id){ return document.getElementById(id); }
      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

      // precise numeric formatting (precision controlled by user)
      function formatNumber(n, precision){
        if(!isFinite(n)) return String(n);
        if(Math.abs(n) < 1e-12) n = 0; // avoid -0
        precision = Number(precision);
        if(Number.isInteger(n)) return String(n);
        if(!Number.isFinite(precision) || precision < 0) precision = 6;
        var s = n.toFixed(precision);
        s = s.replace(/(?:\.0+|0+)$/,'');
        return s;
      }

      /* -------------------- Robust parser -------------------- */
      function safeParseNumber(token){
        var t = String(token).trim();
        if(t === '') return {ok:false, value:null, original:token};
        // Allow thousands separators inside decimals? We remove non-digit except e/E + - + .
        // Remove spaces and commas that users may use as thousands separators
        var normalized = t.replace(/[\s,]+/g, '');
        // Accept number-like: digits, optional decimal, optional exponent
        var numLike = /^[+-]?((\d+\.?\d*)|(\.\d+))(e[+-]?\d+)?$/i;
        if(!numLike.test(normalized)) return {ok:false, value:null, original:token};
        var v = Number(normalized);
        if(!isFinite(v)) return {ok:false, value:null, original:token};
        return {ok:true, value:v, original:token};
      }

      function parseInput(text){
        if(typeof text !== 'string') text = String(text||'');
        var normalized = text.replace(/[\n\r]+/g, ',');
        // split on commas, semicolons, whitespace
        var tokens = normalized.split(/[ ,;]+/);
        var valid = [];
        var invalid = [];
        for(var i=0;i<tokens.length;i++){
          var t = tokens[i];
          if(t === '') continue;
          var r = safeParseNumber(t);
          if(r.ok) valid.push(r.value);
          else invalid.push(r.original);
        }
        return { validNumbers: valid, invalidTokens: invalid };
      }

      function computeStatistics(arr){
        if(!Array.isArray(arr) || arr.length === 0) throw new Error('computeStatistics requires a non-empty array');
        var n = arr.length; var sum = 0; for(var i=0;i<n;i++) sum += arr[i];
        var mean = sum / n;
        var sorted = arr.slice().sort(function(a,b){ return a-b; });
        var median = (n%2===1) ? sorted[(n-1)/2] : (sorted[n/2 -1] + sorted[n/2]) / 2;
        var freq = Object.create(null); var maxf = 0; for(var i=0;i<n;i++){ var k = String(arr[i]); freq[k] = (freq[k]||0) + 1; if(freq[k] > maxf) maxf = freq[k]; }
        var modes = []; for(var k in freq) if(freq[k] === maxf) modes.push(Number(k));
        var variance = 0; for(var i=0;i<n;i++){ var d = arr[i] - mean; variance += d*d; } variance = variance / n; var std = Math.sqrt(variance);
        var min = sorted[0]; var max = sorted[sorted.length-1];
        return { count:n, sum:sum, mean:mean, median:median, modes:modes, std:std, sorted:sorted, min:min, max:max };
      }

      /* -------------------- DOM references -------------------- */
      var numbersEl = $id('numbers');
      var calculateBtn = $id('calculateBtn');
      var clearBtn = $id('clearBtn');
      var pasteExampleBtn = $id('pasteExample');
      var loadDemoBtn = $id('loadDemo');
      var autoCalcCheckbox = $id('autocalc');
      var precisionEl = $id('precision');

      var errorEl = $id('error');
      var statsEl = $id('stats');
      var countEl = $id('count');
      var sumEl = $id('sum');
      var avgEl = $id('avg');
      var medianEl = $id('median');
      var modeEl = $id('mode');
      var stdEl = $id('std');
      var minEl = $id('min');
      var maxEl = $id('max');

      /* -------------------- Calculation logic -------------------- */
      var debounceTimer = null;
      function debounce(fn, delay){ return function(){ var args = arguments; if(debounceTimer) clearTimeout(debounceTimer); debounceTimer = setTimeout(function(){ debounceTimer = null; try{ fn.apply(null,args); }catch(e){ console.error(e); } }, delay); } }

      function showError(msg){ errorEl.textContent = msg; }
      function clearError(){ errorEl.textContent = ''; }

      function updateStatsDisplay(statsObj){
        if(!statsObj || !statsObj.count){ statsEl.style.display = 'none'; return; }
        statsEl.style.display = 'block';
        countEl.textContent = String(statsObj.count);
        sumEl.textContent = formatNumber(statsObj.sum, precisionEl.value);
        avgEl.textContent = formatNumber(statsObj.mean, precisionEl.value);
        medianEl.textContent = formatNumber(statsObj.median, precisionEl.value);
        modeEl.textContent = (statsObj.modes && statsObj.modes.length>0) ? statsObj.modes.map(function(n){return formatNumber(n, precisionEl.value)}).join(', ') : '—';
        stdEl.textContent = formatNumber(statsObj.std, precisionEl.value);
        minEl.textContent = formatNumber(statsObj.min, precisionEl.value);
        maxEl.textContent = formatNumber(statsObj.max, precisionEl.value);
      }

      function calculateAndRender(){
        try{
          clearError();
          var text = numbersEl.value || '';
          var parsed = parseInput(text);
          if(parsed.validNumbers.length === 0){
            if(parsed.invalidTokens.length > 0) showError('No valid numbers. Ignored tokens: ' + parsed.invalidTokens.join(', '));
            else showError('Please enter at least one valid number.');
            updateStatsDisplay(null); return;
          }
          var stats = computeStatistics(parsed.validNumbers);
          updateStatsDisplay(stats);
          if(parsed.invalidTokens.length > 0) showError('Note: ignored tokens — ' + parsed.invalidTokens.join(', '));
        } catch(err){ console.error(err); showError('Unexpected error: ' + (err && err.message ? err.message : String(err))); }
      }

      calculateBtn.addEventListener('click', calculateAndRender);
      clearBtn.addEventListener('click', function(){ numbersEl.value = ''; updateStatsDisplay(null); clearError(); });
      pasteExampleBtn.addEventListener('click', function(){ numbersEl.value = '10, 20, 30, 40, 50, 100, -5, 1e2, 3.14159'; if(autoCalcCheckbox.checked) calculateAndRender(); });
      loadDemoBtn.addEventListener('click', function(){ // random demo generator
        var list = [];
        for(var i=0;i<12;i++){ list.push((Math.random()*200 - 50).toFixed(2)); }
        numbersEl.value = list.join(', ');
        if(autoCalcCheckbox.checked) calculateAndRender();
      });

      numbersEl.addEventListener('input', debounce(function(){ if(autoCalcCheckbox.checked) calculateAndRender(); }, 450));

      // run initial calc if content present
      if(numbersEl.value && autoCalcCheckbox.checked){ try{ calculateAndRender(); }catch(e){} }

      /* -------------------- Music player -------------------- */
      var audio = $id('audio');
      // playlist: continue from 3.mp3 to 10.mp3 per user's request (total 10 tracks)
      var playlist = [
        { src: '1.mp3', title: '1.mp3' },
        { src: '2.mp3', title: '2.mp3' },
        { src: '3.mp3', title: '3.mp3' },
        { src: '4.mp3', title: '4.mp3' },
        { src: '5.mp3', title: '5.mp3' },
        { src: '6.mp3', title: '6.mp3' },
        { src: '7.mp3', title: '7.mp3' },
        { src: '8.mp3', title: '8.mp3' },
        { src: '9.mp3', title: '9.mp3' },
        { src: '10.mp3', title: '10.mp3' }
      ];

      var currentIndex = 0; var isPlaying = false; var repeatMode = 0; // 0 off,1 all,2 one
      var isShuffled = false; var shuffleOrder = null; var savedIndexMap = null;

      // references
      var playBtn = $id('playBtn');
      var prevBtn = $id('prevBtn');
      var nextBtn = $id('nextBtn');
      var stopBtn = $id('stopBtn');
      var volumeSlider = $id('volumeSlider');
      var repeatBtn = $id('repeatBtn');
      var progressBar = $id('progressBar');
      var progressContainer = $id('progressContainer');
      var trackInfo = $id('trackInfo');
      var playlistEl = $id('playlist');
      var timeDisplay = $id('timeDisplay');
      var shuffleBtn = $id('shuffleBtn');
      var downloadBtn = $id('downloadBtn');
      var showAllBtn = $id('showAllBtn');

      // try to set audio src safely and detect missing files
      function setSourceToIndex(idx){
        idx = clamp(idx, 0, playlist.length-1);
        currentIndex = idx;
        var entry = playlist[currentIndex];
        audio.pause();
        audio.removeAttribute('src');
        audio.src = entry.src;
        audio.load();
        trackInfo.textContent = entry.title;
        updatePlaylistUI();
      }

      function updatePlayButton(){ playBtn.textContent = isPlaying ? '❚❚' : '►'; playBtn.title = isPlaying ? 'Pause' : 'Play'; }

      function playCurrent(){
        if(!audio.src) setSourceToIndex(currentIndex);
        var p = audio.play();
        if(p && p.then){ p.then(function(){ isPlaying = true; updatePlayButton(); }).catch(function(err){ console.warn('Playback blocked or failed',err); isPlaying = false; updatePlayButton(); showError('Playback blocked by browser or file missing. Click play again or check files.'); }); }
        else { isPlaying = true; updatePlayButton(); }
      }

      function pauseCurrent(){ try{ audio.pause(); }catch(e){} isPlaying = false; updatePlayButton(); }
      function stopCurrent(){ try{ audio.pause(); audio.currentTime = 0; }catch(e){} isPlaying = false; updatePlayButton(); }

      function prevTrack(){ if(audio.currentTime > 2) { audio.currentTime = 0; return; } var nextIdx = (currentIndex - 1 + playlist.length) % playlist.length; setSourceToIndex(nextIdx); if(isPlaying) playCurrent(); }
      function nextTrack(){ var nextIdx = currentIndex + 1; if(nextIdx >= playlist.length){ if(repeatMode === 1) nextIdx = 0; else { stopCurrent(); return; } } setSourceToIndex(nextIdx); if(isPlaying) playCurrent(); }

      function cycleRepeat(){ repeatMode = (repeatMode + 1) % 3; var label = 'Repeat: Off'; if(repeatMode === 1) label = 'Repeat: All'; if(repeatMode === 2) label = 'Repeat: One'; repeatBtn.textContent = label; repeatBtn.setAttribute('aria-pressed', repeatMode !== 0); }

      // shuffle implementation preserves a mapping so we can unshuffle reliably
      function createShuffleOrder(){ var order = []; for(var i=0;i<playlist.length;i++) order.push(i); for(var i=order.length-1;i>0;i--){ var j = Math.floor(Math.random()*(i+1)); var tmp = order[i]; order[i] = order[j]; order[j] = tmp; } return order; }

      function applyShuffle(on){
        if(on && !isShuffled){ shuffleOrder = createShuffleOrder(); savedIndexMap = { currentIndex: currentIndex }; // save current
          // map current index to its position in shuffle order
          var pos = shuffleOrder.indexOf(currentIndex);
          if(pos === -1) pos = 0; currentIndex = shuffleOrder[pos]; isShuffled = true; shuffleBtn.setAttribute('aria-pressed','true'); shuffleBtn.textContent = 'Shuffle: On';
        } else if(!on && isShuffled){ // unshuffle: try restore saved index
          if(savedIndexMap && typeof savedIndexMap.currentIndex === 'number') currentIndex = savedIndexMap.currentIndex; shuffleOrder = null; savedIndexMap = null; isShuffled = false; shuffleBtn.setAttribute('aria-pressed','false'); shuffleBtn.textContent = 'Shuffle'; }
        updatePlaylistUI(); setSourceToIndex(currentIndex);
      }

      // update progress and time display
      function secToMMSS(s){ s = Math.floor(s||0); var m = Math.floor(s/60); var sec = s%60; return m+':' + (sec<10?'0':'')+sec; }
      function updateProgress(){ try{ if(!isFinite(audio.duration) || audio.duration<=0) { progressBar.style.width='0%'; timeDisplay.textContent = secToMMSS(audio.currentTime) + ' / ' + secToMMSS(audio.duration||0); return; } var pct = (audio.currentTime / audio.duration) * 100; pct = clamp(pct,0,100); progressBar.style.width = pct + '%'; timeDisplay.textContent = secToMMSS(audio.currentTime) + ' / ' + secToMMSS(audio.duration); }catch(e){ progressBar.style.width='0%'; } }

      // playlist UI
      function updatePlaylistUI(){ playlistEl.innerHTML = ''; for(var i=0;i<playlist.length;i++){ var tr = document.createElement('div'); tr.className = 'track'; tr.setAttribute('data-index', i); var title = document.createElement('div'); title.textContent = playlist[i].title; var right = document.createElement('div'); right.textContent = '';
          if(i === currentIndex) tr.setAttribute('aria-current','true'); else tr.removeAttribute('aria-current');
          tr.appendChild(title); tr.appendChild(right);
          (function(index){ tr.addEventListener('click', function(){ setSourceToIndex(index); playCurrent(); }); })(i);
          playlistEl.appendChild(tr);
      } }

      // seek by clicking progress container
      progressContainer.addEventListener('click', function(e){ try{ var rect = progressContainer.getBoundingClientRect(); var x = e.clientX - rect.left; var pct = x / rect.width; pct = clamp(pct,0,1); if(isFinite(audio.duration) && audio.duration>0){ audio.currentTime = pct * audio.duration; updateProgress(); } }catch(err){} });

      // volume
      function setVolume(v){ v = Number(v); if(isNaN(v)) v = 0.6; v = clamp(v,0,1); try{ audio.volume = v; }catch(e){} }
      setVolume(volumeSlider.value);
      volumeSlider.addEventListener('input', function(e){ setVolume(e.target.value); });

      // keyboard shortcuts
      document.addEventListener('keydown', function(e){ var tag = (document.activeElement && document.activeElement.tagName)||''; if(tag === 'INPUT' || tag === 'TEXTAREA') return; if(e.code === 'Space'){ e.preventDefault(); if(isPlaying) pauseCurrent(); else playCurrent(); } else if(e.key === 'ArrowLeft'){ prevTrack(); } else if(e.key === 'ArrowRight'){ nextTrack(); } else if(e.key === 's' || e.key === 'S'){ applyShuffle(!isShuffled); } else if(e.key === 'r' || e.key === 'R'){ cycleRepeat(); } else if(e.key === 'm' || e.key === 'M'){ // mute toggle
          if(Math.abs(audio.volume) < 0.0001){ setVolume(0.6); volumeSlider.value = 0.6; } else { setVolume(0); volumeSlider.value = 0; } }
      });

      // attach control events
      playBtn.addEventListener('click', function(){ if(isPlaying) pauseCurrent(); else playCurrent(); });
      prevBtn.addEventListener('click', prevTrack);
      nextBtn.addEventListener('click', nextTrack);
      stopBtn.addEventListener('click', stopCurrent);
      repeatBtn.addEventListener('click', cycleRepeat);
      shuffleBtn.addEventListener('click', function(){ applyShuffle(!isShuffled); });

      // audio events
      audio.addEventListener('timeupdate', updateProgress);
      audio.addEventListener('loadedmetadata', updateProgress);
      audio.addEventListener('ended', function(){ if(repeatMode === 2){ audio.currentTime = 0; playCurrent(); return; } if(currentIndex < playlist.length - 1){ setSourceToIndex(currentIndex + 1); playCurrent(); } else { if(repeatMode === 1){ setSourceToIndex(0); playCurrent(); } else { stopCurrent(); } } });

      // error handling on audio (file missing, decode error)
      audio.addEventListener('error', function(e){ var code = audio.error && audio.error.code; console.warn('Audio error', code, e); showError('Audio playback error (file may be missing or corrupted). Skipping to next.'); // try skip to next after short delay
        setTimeout(function(){ try{ if(currentIndex < playlist.length -1){ setSourceToIndex(currentIndex+1); if(isPlaying) playCurrent(); } else { stopCurrent(); } }catch(err){} }, 800);
      });

      // download current
      downloadBtn.addEventListener('click', function(){ var entry = playlist[currentIndex]; var a = document.createElement('a'); a.href = entry.src; a.download = entry.title; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(function(){ document.body.removeChild(a); }, 100); });

      // showAll toggles focus for playlist for a11y
      showAllBtn.addEventListener('click', function(){ playlistEl.focus(); });

      // initialize UI
      updatePlaylistUI(); setSourceToIndex(currentIndex); updatePlayButton(); repeatBtn.textContent = 'Repeat: Off'; shuffleBtn.textContent = 'Shuffle'; shuffleBtn.setAttribute('aria-pressed','false');

      // small debug window for local dev (exposed safely)
      window.__avgcalc_debug = { parseInput: parseInput, computeStatistics: computeStatistics, playlist: playlist };

      // Accessibility: announce when track changes (for screen readers)
      var liveRegion = document.createElement('div'); liveRegion.setAttribute('aria-live','polite'); liveRegion.setAttribute('aria-atomic','true'); liveRegion.style.position='absolute'; liveRegion.style.left='-9999px'; liveRegion.style.height='1px'; liveRegion.style.overflow='hidden'; document.body.appendChild(liveRegion);
      function announce(msg){ try{ liveRegion.textContent = msg; }catch(e){} }
      audio.addEventListener('play', function(){ announce('Playing ' + (playlist[currentIndex] && playlist[currentIndex].title ? playlist[currentIndex].title : 'track')); });
      audio.addEventListener('pause', function(){ if(!audio.ended) announce('Paused'); });
      audio.addEventListener('ended', function(){ announce('Track ended'); });

      // Defensive: if some files are missing, mark them but keep playlist intact
      // We attempt to fetch the first few bytes of each file using fetch with range if available (graceful, no cross-origin requests expected)
      (function probeFiles(){ if(!('fetch' in window)) return; // skip if no fetch
        playlist.forEach(function(entry, idx){ // try HEAD request
          try{
            fetch(entry.src, { method: 'HEAD' }).then(function(resp){ if(!resp.ok) { // mark missing visually
                var el = playlistEl.querySelector('[data-index="'+idx+'"]'); if(el) el.style.opacity = 0.4; }
            }).catch(function(){ var el = playlistEl.querySelector('[data-index="'+idx+'"]'); if(el) el.style.opacity = 0.4; });
          }catch(e){}
        });
      })();

      // end player
    })();
  </script>
</body>
</html>





